{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="text-center">
    <h1 class="text-3xl font-bold mb-6">Welcome to the Video and Webcam Processing App</h1>

    <div class="mb-4">
        <button id="startWebcam" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Start Webcam
        </button>
        <button id="stopWebcam" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
            Stop Webcam
        </button>
    </div>

    <div id="webcamContainer" style="display:none;">
        <img id="webcamFeed" class="w-full h-96 border-2 border-gray-300" src="">
        <div id="predictions" class="mt-4 text-left">
            <!-- Predictions will be inserted here -->
        </div>
    </div>

    <div class="mt-6">
        <button onclick="showUploadVideoForm()"
            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
            Upload Video or YouTube URL
        </button>
        <div id="uploadVideoForm" style="display:none;">
            <form method="post" enctype="multipart/form-data" action="{% url 'upload_video' %}" class="mt-4">
                {% csrf_token %}
                {{ video_form.as_p }}
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Upload
                </button>
            </form>
        </div>
    </div>

    <div class="mt-6">
        <button onclick="showUploadImageForm()"
            class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
            Upload Image
        </button>
        <div id="uploadImageForm" style="display:none;">
            <form method="post" enctype="multipart/form-data" action="{% url 'upload_image' %}" class="mt-4">
                {% csrf_token %}
                {{ image_form.as_p }}
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Upload
                </button>
            </form>
        </div>
    </div>

    <div class="mt-6">
        {% if video_name %}
        <button id="playVideo" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
            onclick="startVideo('{{ video_name }}')">Play Video</button>
        <button id="stopVideo" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
            onclick="stopVideo()">Stop Video</button>
        {% elif youtube_url %}
        <button id="playYoutubeVideo" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
            onclick="startVideo('{{ youtube_url }}')">Play YouTube Video</button>
        <button id="stopYoutubeVideo" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
            onclick="stopVideo()">Stop YouTube Video</button>
        {% endif %}
    </div>

    <div id="videoContainer" style="display:none;">
        <img id="videoFeed" class="w-full h-96 border-2 border-gray-300" src="">
        <div id="videoPredictions" class="mt-4 text-left">
            <!-- Predictions will be inserted here -->
        </div>
    </div>

    <div class="mt-6">
        {% if image_name %}
        <button id="startImage" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
            onclick="startImage('{{ image_name }}')">Start Image</button>
        <button id="stopImage" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
            onclick="stopImage()">Stop Image</button>
        {% endif %}
    </div>

    <div id="imageContainer" style="display:none;">
        <img id="imageFeed" class="w-full h-96 border-2 border-gray-300" src="">
        <div id="imagePredictions" class="mt-4 text-left">
            <!-- Predictions will be inserted here -->
        </div>
    </div>
</div>

<script>
    let socket;

    function closeAllStreams() {
        if (socket) {
            socket.send(JSON.stringify({ 'command': 'stop' }));
            socket.close();
        }
        document.getElementById('webcamContainer').style.display = 'none';
        document.getElementById('videoContainer').style.display = 'none';
        document.getElementById('imageContainer').style.display = 'none';
    }

    function openWebcam() {
        closeAllStreams();
        document.getElementById('webcamContainer').style.display = 'block';
        socket = new WebSocket('ws://' + window.location.host + '/ws/video_feed/');

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            document.getElementById('webcamFeed').src = 'data:image/jpeg;base64,' + data.frame;
        };

        socket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        socket.onopen = function () {
            socket.send(JSON.stringify({ 'command': 'start', 'video_type': 'webcam' }));
        };

        socket.onclose = function () {
            socket = null;
        };
    }

    function stopWebcam() {
        closeAllStreams();
    }

    function startVideo(videoPath) {
        closeAllStreams();
        document.getElementById('videoContainer').style.display = 'block';
        socket = new WebSocket('ws://' + window.location.host + '/ws/video_feed/');

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            document.getElementById('videoFeed').src = 'data:image/jpeg;base64,' + data.frame;
        };

        socket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        socket.onopen = function () {
            socket.send(JSON.stringify({ 'command': 'start', 'video_type': 'video', 'video_path': videoPath }));
        };

        socket.onclose = function () {
            socket = null;
        };
    }

    function stopVideo() {
        closeAllStreams();
    }

    function startImage(imagePath) {
        closeAllStreams();
        document.getElementById('imageContainer').style.display = 'block';
        socket = new WebSocket('ws://' + window.location.host + '/ws/video_feed/');

        socket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            document.getElementById('imageFeed').src = 'data:image/jpeg;base64,' + data.frame;
        };

        socket.onerror = function (error) {
            console.error('WebSocket error:', error);
        };

        socket.onopen = function () {
            socket.send(JSON.stringify({ 'command': 'start', 'video_type': 'image', 'video_path': imagePath }));
        };

        socket.onclose = function () {
            socket = null;
        };
    }

    function stopImage() {
        closeAllStreams();
    }

    function showUploadVideoForm() {
        document.getElementById('uploadVideoForm').style.display = 'block';
    }

    function showUploadImageForm() {
        document.getElementById('uploadImageForm').style.display = 'block';
    }

    document.getElementById('startWebcam').addEventListener('click', openWebcam);
    document.getElementById('stopWebcam').addEventListener('click', stopWebcam);
</script>

{% endblock %}